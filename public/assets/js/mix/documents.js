function createThumbnail(e,t,n){var a=document.createElement("div");a.className="col-md-12",e.appendChild(a);var i=document.createElement("div");i.className="card mb-4 shadow-sm text-center",a.appendChild(i);var r=document.createElement("img");r.style.width="360px",r.className="card-img-top th_img",r.id=t,r.width=360,i.appendChild(r);var o=document.createElement("div");o.className="progress th_progress",o.innerHTML='<div class="progress-bar bg-warning" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>',i.appendChild(o);var s=document.createElement("button");s.className="close text-danger th_remove",s.setAttribute("type","button"),s.setAttribute("aria-label","Remove"),s.innerHTML='<span aria-hidden="true">&times;</span>',i.appendChild(s),s.addEventListener("click",function(e){e.target.parentNode.parentNode.remove(),$("#btn-scan").show(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!0).addClass("disabled")},!1)}function appendImage(e,t){function n(e,t,n,a){var i=[n/e,a/t];return i=Math.min(i[0],i[1]),{width:e*i,height:t*i}}var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,i=new Image;i.src=window.URL.createObjectURL(e),i.onload=function(){var e=document.createElement("canvas");if(this.naturalWidth<a&&this.naturalHeight<a)var i={width:this.naturalWidth,height:this.naturalHeight};else var i=n(this.naturalWidth,this.naturalHeight,a,a);e.width=i.width,e.height=i.height,e.getContext("2d").drawImage(this,0,0,this.naturalWidth,this.naturalHeight,0,0,i.width,i.height),e.toBlob(function(e){document.getElementById(t).src=window.URL.createObjectURL(e)},"image/jpeg",.9),e.remove()},i.remove()}function uploadImage(e){fetch(e.src).then(function(e){return e.blob()}).then(function(t){scannerForm=document.getElementById("scanner-form");var n=new FormData(scannerForm);n.append("type","image_upload"),n.append("blob",t);var a=new XMLHttpRequest;a.addEventListener("loadstart",function(t){[].slice.call(e.parentNode.children).filter(function(t){return t!==e}).forEach(function(e){"th_rotate"!=e.className&&"close th_remove"!=e.className||e.remove(),"progress th_progress"==e.className&&(e.style.display="flex")})},!1),a.upload.addEventListener("progress",function(t){if(t.lengthComputable){var n=Math.round(100*t.loaded/t.total);e.nextSibling.nextSibling.firstChild.style.width=n+"%",e.nextSibling.nextSibling.firstChild.setAttribute("aria-valuenow",n)}},!1),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?(as.btn.stopLoading($("#scannerUploader .actions a[href='#finish']")),window.location.href=redirectAfterUpload):($("#uploadServerError").show(),as.btn.stopLoading($("#scannerUploader .actions a[href='#finish']"))))},a.open("POST",filesScannerRoute),a.overrideMimeType("text/plain; charset=x-user-defined-binary"),a.send(n)})}window.URL=window.URL||window.webkitURL,document.addEventListener("DOMContentLoaded",function(){function e(e){if(console.log(e),e.length>0)for(var t=0;t<e.length;t++){var n=e[t].split(":value"),a=n[n.length-1],i=n[0];$("#sources-list").append("<option value="+a+">"+i+"</option>")}}var t=(document.getElementById("select_images_input"),document.getElementById("th_container")),n=document.getElementById("btn-scan"),a=document.getElementById("download-app"),i=document.getElementById("btn-upload"),r=0,o=window.WebSocket||window.MozWebSocket;window.ws=new o("ws://"+currentClientIp+":4000"),ws.onmessage=function(n){if("EnableScan"==n.data)$("#btn-scan").show();else if(n.data instanceof Blob){r++,null!=document.getElementById("th_container_empty")&&(document.getElementById("th_container_empty").style.display="none");var a="upl_image"+r;createThumbnail(t,a,"Scan "+r),appendImage(n.data,a),as.btn.stopLoading($("#btn-scan")),$("#btn-scan").hide(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!1).removeClass("disabled")}else{var i=n.data.split(",");e(i)}},$("#sources-list").on("change",function(e){$("#btn-scan").hide(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!0).addClass("disabled"),$(".th_remove").length>0&&$(".th_remove").click();var t=$(this).find("option:selected").val();ws.send(JSON.stringify({message:"1300",source:t}))}),ws.onopen=function(){n.removeAttribute("disabled"),a.style.display="none",as.btn.stopLoading($("#btn-scan")),$("#sources-list").html("<option disabled selected>Sélectionner un scanner</option>"),ws.send(JSON.stringify({message:"1200"}))},ws.onerror=function(e){n.setAttribute("disabled",""),as.btn.stopLoading($("#btn-scan")),a.style.display=""},$("#btn-scan").on("click",function(e){as.btn.loading($("#btn-scan"),btnScanningText),ws.send(JSON.stringify({message:"1100"}))}),$("#btn-upload").on("click",function(e){i.style.display="none",Array.from(document.querySelectorAll("img.th_img")).forEach(function(e){uploadImage(e)})})}),document.addEventListener("click",function(e){if(e.target&&"th_rotate"==e.target.className){var t=document.createElement("canvas"),n=t.getContext("2d"),a=e.target.previousElementSibling,i=new Image;i.src=a.src,i.onload=function(){imgWidth=i.width,imgHeight=i.height,t.width=imgHeight,t.height=imgWidth,n.translate(t.width/2,t.height/2),n.rotate(90*Math.PI/180),n.translate(-t.height/2,-t.width/2),n.drawImage(i,0,0),t.toBlob(function(e){window.URL.revokeObjectURL(a.src),a.src=window.URL.createObjectURL(e)},"image/jpeg",.9)}}}),$(document).ready(function(){moment.locale("fr");var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("objet","expiditeur","destinataire","num_enrg","num_text","sig_ext","sig_int"),queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:prefetchRoute,filter:function(e){return $.map(e,function(e){return{name:e}})}},remote:{url:route+"?term=%QUERY%",wildcard:"%QUERY%"}});e.initialize(),$(".find-document").typeahead(null,{source:e.ttAdapter(),templates:{empty:['<div class="list-group search-results-dropdown"><div class="list-group-item autocomplete-empty"><img width="90px" style="display: block;margin:auto" src="'+emptySearchImage+'"><div><h6 class="tx-center mg-t-20">'+noResutFound+"</h6></div></div></div>"],header:['<div class="list-group search-results-dropdown">'],suggestion:function(e){return'<a href="javascript:void(0);" class="list-group-item card-events"><ul class="list-unstyled media-list mg-b-0">    <li class="media">\n        <div class="media-left">\n            <label>'+moment(e.created_at).format("MMM")+"</label>\n            <p>"+moment(e.created_at).format("DD")+'</p>\n        </div>\n        <div class="media-body event-panel-primary">\n            <span class="event-time">'+moment(e.date_arrivee).format("DD-MM-YYYY")+'</span>\n            <h6 class="event-title">'+e.objet+'</h6>\n            <p class="event-desc">'+e.expiditeur+"</p>\n        </div>\n    </li></ul></a>"}},display:function(e){return e.objet}}).on("typeahead:selected",function(e){e.target.form.submit()}),$(".importance").on("click",function(e){value=$(this).data("value"),$("input#importance-filter").val(value),$(".search-form").submit()}),$(".find-document").on("search",function(e){$(".search-form").submit()}),$(".deleteImportance").on("click",function(e){e.stopPropagation(),$("input#importance-filter").val(""),$(".search-form").submit()}),$(".order-by").on("click",function(e){value=$(this).data("value"),$("input#orderBy").val(value),$(".search-form").submit()}),$(".deleteOrder").on("click",function(e){e.stopPropagation(),$("input#orderBy").val(""),$(".search-form").submit()})}),$("#scannerUploader").steps({headerTag:"h3",bodyTag:"section",autoFocus:!0,titleTemplate:'<span class="number">#index#</span> <span class="title">#title#</span>',onInit:function(){$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!0).addClass("disabled")},onStepChanging:function(e,t,n){return 0!=t||0!=$(".th_img").length},onFinishing:function(e,t){return!!$("#scanner-form").valid()&&(as.btn.loading($("#scannerUploader .actions a[href='#finish']")),!0)},onFinished:function(e,t){$("#btn-upload").click()},transitionEffect:$.fn.steps.transitionEffect.none,transitionEffectSpeed:600,labels:{cancel:"Annuler",current:"current step:",pagination:"Pagination",finish:"Terminer",next:"Suivant",previous:"Précédent",loading:"Chargement ..."}});