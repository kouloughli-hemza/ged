function createThumbnail(e,t,n){var a=document.createElement("div");a.className="col-md-12",e.appendChild(a);var i=document.createElement("div");i.className="card mb-4 shadow-sm text-center",a.appendChild(i);var o=document.createElement("img");o.style.width="360px",o.className="card-img-top th_img",o.id=t,o.width=360,i.appendChild(o);var r=document.createElement("div");r.className="progress th_progress",r.innerHTML='<div class="progress-bar bg-warning" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>',i.appendChild(r);var s=document.createElement("button");s.className="close text-danger th_remove",s.setAttribute("type","button"),s.setAttribute("aria-label","Remove"),s.innerHTML='<span aria-hidden="true">&times;</span>',i.appendChild(s),s.addEventListener("click",function(e){e.target.parentNode.parentNode.remove(),$("#btn-scan").show(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!0).addClass("disabled")},!1)}function appendImage(e,t){function n(e,t,n,a){var i=[n/e,a/t];return i=Math.min(i[0],i[1]),{width:e*i,height:t*i}}var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,i=new Image;i.src=window.URL.createObjectURL(e),i.onload=function(){var e=document.createElement("canvas");if(this.naturalWidth<a&&this.naturalHeight<a)var i={width:this.naturalWidth,height:this.naturalHeight};else var i=n(this.naturalWidth,this.naturalHeight,a,a);e.width=i.width,e.height=i.height,e.getContext("2d").drawImage(this,0,0,this.naturalWidth,this.naturalHeight,0,0,i.width,i.height),e.toBlob(function(e){document.getElementById(t).src=window.URL.createObjectURL(e)},"image/jpeg",.9),e.remove()},i.remove()}function uploadImage(e){fetch(e.src).then(function(e){return e.blob()}).then(function(t){scannerForm=document.getElementById("scanner-form");var n=new FormData(scannerForm);n.append("type","image_upload"),n.append("blob",t);var a=new XMLHttpRequest;a.addEventListener("loadstart",function(t){[].slice.call(e.parentNode.children).filter(function(t){return t!==e}).forEach(function(e){"th_rotate"!=e.className&&"close th_remove"!=e.className||e.remove(),"progress th_progress"==e.className&&(e.style.display="flex")})},!1),a.upload.addEventListener("progress",function(t){if(t.lengthComputable){var n=Math.round(100*t.loaded/t.total);e.nextSibling.nextSibling.firstChild.style.width=n+"%",e.nextSibling.nextSibling.firstChild.setAttribute("aria-valuenow",n)}},!1),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?(as.btn.stopLoading($("#scannerUploader .actions a[href='#finish']")),window.location.href=redirectAfterUpload):($("#uploadServerError").show(),as.btn.stopLoading($("#scannerUploader .actions a[href='#finish']"))))},a.open("POST",filesScannerRoute),a.overrideMimeType("text/plain; charset=x-user-defined-binary"),a.send(n)})}window.URL=window.URL||window.webkitURL,document.addEventListener("DOMContentLoaded",function(){function e(e){if(console.log(e),e.length>0)for(var t=0;t<e.length;t++){var n=e[t].split(":value"),a=n[n.length-1],i=n[0];$("#sources-list").append("<option value="+a+">"+i+"</option>")}}var t=(document.getElementById("select_images_input"),document.getElementById("th_container")),n=document.getElementById("btn-scan"),a=document.getElementById("download-app"),i=document.getElementById("btn-upload"),o=0,r=window.WebSocket||window.MozWebSocket;window.ws=new r("ws://"+currentClientIp+":4000"),ws.onmessage=function(n){if("EnableScan"==n.data)$("#btn-scan").show();else if(n.data instanceof Blob){o++,null!=document.getElementById("th_container_empty")&&(document.getElementById("th_container_empty").style.display="none");var a="upl_image"+o;createThumbnail(t,a,"Scan "+o),appendImage(n.data,a),as.btn.stopLoading($("#btn-scan")),$("#btn-scan").hide(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!1).removeClass("disabled")}else{var i=n.data.split(",");e(i)}},$("#sources-list").on("change",function(e){$("#btn-scan").hide(),$("#scannerUploader .actions a[href='#next']").parent().attr("aria-disabled",!0).addClass("disabled"),$(".th_remove").length>0&&$(".th_remove").click();var t=$(this).find("option:selected").val();ws.send(JSON.stringify({message:"1300",source:t}))}),ws.onopen=function(){n.removeAttribute("disabled"),a.style.display="none",as.btn.stopLoading($("#btn-scan")),$("#sources-list").html("<option disabled selected>SÃ©lectionner un scanner</option>"),ws.send(JSON.stringify({message:"1200"}))},ws.onerror=function(e){n.setAttribute("disabled",""),as.btn.stopLoading($("#btn-scan")),a.style.display=""},$("#btn-scan").on("click",function(e){as.btn.loading($("#btn-scan"),btnScanningText),ws.send(JSON.stringify({message:"1100"}))}),$("#btn-upload").on("click",function(e){i.style.display="none",Array.from(document.querySelectorAll("img.th_img")).forEach(function(e){uploadImage(e)})})}),document.addEventListener("click",function(e){if(e.target&&"th_rotate"==e.target.className){var t=document.createElement("canvas"),n=t.getContext("2d"),a=e.target.previousElementSibling,i=new Image;i.src=a.src,i.onload=function(){imgWidth=i.width,imgHeight=i.height,t.width=imgHeight,t.height=imgWidth,n.translate(t.width/2,t.height/2),n.rotate(90*Math.PI/180),n.translate(-t.height/2,-t.width/2),n.drawImage(i,0,0),t.toBlob(function(e){window.URL.revokeObjectURL(a.src),a.src=window.URL.createObjectURL(e)},"image/jpeg",.9)}}});